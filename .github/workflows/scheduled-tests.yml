# Tests Planifi√©s - V√©rifications r√©guli√®res

name: Scheduled Tests

on:
  schedule:
    # Tous les jours √† 2h du matin
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  # Tests de sant√© en production
  health-check:
    name: üè• Production Health Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Check production endpoint
      run: |
        # Remplacer par votre URL de production
        PROD_URL="https://axiom-portal.example.com"
        
        # Test de disponibilit√©
        if curl --fail --silent --max-time 10 "$PROD_URL" > /dev/null; then
          echo "‚úÖ Production is healthy"
        else
          echo "‚ùå Production health check failed"
          exit 1
        fi

    - name: Check API endpoints
      run: |
        # Tester les endpoints critiques
        curl --fail https://axiom-portal.example.com/api/health || exit 1
        echo "‚úÖ API endpoints are responding"

  # Tests de performance
  performance-tests:
    name: ‚ö° Performance Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run k6 performance tests
      uses: grafana/k6-action@v0.3.0
      with:
        filename: tests/performance/load-test.js
      continue-on-error: true

  # Scan de s√©curit√©
  security-scan:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

  # V√©rifier les d√©pendances obsol√®tes
  dependency-check:
    name: üì¶ Dependency Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '18'

    - name: Check outdated packages
      run: |
        npm outdated || echo "Some packages are outdated"

    - name: Check for updates
      run: |
        npx npm-check-updates -u --target minor || echo "Updates available"

  # Notification
  notify:
    name: üì¢ Notify Results
    needs: [health-check, security-scan, dependency-check]
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
    - name: Send notification
      run: |
        echo "‚ö†Ô∏è Scheduled tests detected issues!"
        echo "Health Check: ${{ needs.health-check.result }}"
        echo "Security Scan: ${{ needs.security-scan.result }}"
        echo "Dependencies: ${{ needs.dependency-check.result }}"
