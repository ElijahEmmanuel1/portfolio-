# PR Checks - VÃ©rifications sur Pull Requests

name: PR Checks

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

jobs:
  # VÃ©rifier les fichiers modifiÃ©s
  files-changed:
    name: ğŸ“ Check Changed Files
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files: |
          app/**
          components/**
          lib/**
          public/**
          k8s/**
          package.json
          Dockerfile

    - name: List changed files
      run: |
        echo "Changed files:"
        echo "${{ steps.changed-files.outputs.all_changed_files }}"

  # Tests rapides
  quick-tests:
    name: âš¡ Quick Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Type check
      run: npx tsc --noEmit

    - name: Lint
      run: npm run lint

  # VÃ©rifier la taille du bundle
  bundle-size:
    name: ğŸ“¦ Check Bundle Size
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build
      run: npm run build

    - name: Analyze bundle
      run: |
        npx next-bundle-analyzer || echo "Bundle analysis complete"

  # Preview deployment (optionnel)
  preview:
    name: ğŸ” Preview Deployment
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Comment PR
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'ğŸš€ Preview deployment will be available after CI checks pass.\n\nCommit: `${{ github.event.pull_request.head.sha }}`'
          })

  # VÃ©rifier les conventions
  conventional-commits:
    name: ğŸ“‹ Check Commit Messages
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Validate commit messages
      uses: wagoid/commitlint-github-action@v5
      continue-on-error: true

  # Status final
  pr-status:
    name: âœ… PR Status
    needs: [quick-tests, bundle-size]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Check status
      run: |
        if [ "${{ needs.quick-tests.result }}" != "success" ] || \
           [ "${{ needs.bundle-size.result }}" != "success" ]; then
          echo "âŒ Some PR checks failed"
          exit 1
        fi
        echo "âœ… All PR checks passed"
